{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"AOSP Build Include Graph","text":"<p>In AOSP Project one of biggest thing is the build system, it is using soong, ninja, kati, blueprint etc., During the build, the AndroidProducts.mk and BoardConfig.mk files get read by the build system to configure it. files get read by the build system to configure it. When creating your own build, you presumably include fragments found in build/make/target to set up standard apps. However, if you look into it, where to start isn't clear. At least it wasn't to me. Reading the mk files gets unwieldy with all the indirection so I created a small script to graph out how things are included.</p> <p></p> <p>Here, it's easier to see which parts are at the top of the tree and how one include affects another.</p>"},{"location":"#python-script-to-create-the-graph","title":"Python Script to Create the Graph","text":"build_include.py<pre><code>#!/usr/bin/env python\n# Convert AOSP build include egrep output to visual graph via graphviz\n# ---\n# In aosp/build/make/, run something like:\n#  egrep -R '(inherit|include)' target/ | python3 build_include.py | dot -Tpng &gt; build-includes.png\nimport re\nimport sys\nlines = sys.stdin.readlines()\nnodes = {}\npairs = []\nfor l in lines:\nl = l.replace(\"$(SRC_TARGET_DIR)\", \"target\")\nl = l.replace(\"build/make/target\", \"target\")\nm = re.match('^([-\\.\\w/_]+):(([\\s ,-]|include|\\$\\(call|inherit|product|if|exists))*([-\\.\\w/_]+\\.mk)\\)?', l)\nif m:\nmfile = m.group(1)\nminclude = m.group(4)\nfor k in (mfile,minclude):\nif not k in nodes:\nnodes[k] = len(nodes)\npairs.append((mfile,minclude))\nelse:\nsys.stderr.write('Dropped line: {}\\n'.format(l))\nprint(\"strict digraph includes {\")\nprint(\"\\trankdir=LR\")\nfor (k,v) in nodes.items():\nprint(\"\\tn{} [label=\\\"{}\\\" shape=box]\".format(v, k))\nfor (mfile,minclude) in pairs:\nprint(\"\\tn{} -&gt; n{}\".format(nodes[mfile], nodes[minclude]))\nprint(\"}\")\n</code></pre>"},{"location":"#how-to-run-the-script","title":"How to Run the Script","text":"<p>In Your AOSP source code goto build/make/ directory and save this script in the same location as build_include.py and execute the following command.</p> <pre><code>egrep -R '(inherit|include)' target/ | python3 build_include.py | dot -Tpng &gt; build-includes.png\n</code></pre> <p>By running the above script one build-includes.png file will get saved in the current directory.</p> <p>if you want to save as pdf you run the below command. <pre><code>egrep -R '(inherit|include)' target/ | python3 build_include.py | dot -Tpdf &gt; build-includes.pdf\n</code></pre></p>"},{"location":"#python-script-for-any-folder-in-the-aosp-source-tree","title":"Python Script for Any Folder in the AOSP Source tree","text":"build_include.py<pre><code>#!/usr/bin/env python\n# Convert AOSP build include egrep output to visual graph via graphviz\n# ---\n# In device/google/, run something like:\n#  egrep -R '(inherit|include)' * | python3 build_include.py | dot -Tpng &gt; build-includes.png\nimport os\nimport re\nimport sys\nlines = sys.stdin.readlines()\nnodes = {}\npairs = []\nfor l in lines:\nl = l.replace(\"$(SRC_TARGET_DIR)\", \"target\")\nl = l.replace(\"build/make/target\", \"target\")\nm = re.match('^([-\\.\\w/_]+):(([\\s ,-]|include|\\$\\(call|inherit|product|if|exists))*([-\\.\\w/_]+\\.mk)\\)?', l)\nif m:\nmfile = os.path.join(os.getcwd(), m.group(1))\nminclude = os.path.join(os.getcwd(), m.group(4))\nfor k in (mfile, minclude):\nif not k in nodes:\nnodes[k] = len(nodes)\npairs.append((mfile, minclude))\nelse:\nsys.stderr.write('Dropped line: {}\\n'.format(l))\nprint(\"strict digraph includes {\")\nprint(\"\\trankdir=LR\")\nfor (k, v) in nodes.items():\nlabel = k.replace(os.getcwd() + \"/\", \"\")\nprint(\"\\tn{} [label=\\\"{}\\\" shape=box]\".format(v, label))\nfor (mfile, minclude) in pairs:\nprint(\"\\tn{} -&gt; n{}\".format(nodes[mfile], nodes[minclude]))\nprint(\"}\")\n</code></pre>"},{"location":"#run-the-script-with-following-command","title":"Run the script with following command","text":"<p>Run the script with following command</p> <pre><code>egrep -R '(inherit|include)' . | python3 build_include.py | dot -Tpng &gt; build-includes.png\n</code></pre> <p>below command is for to generate the output in pdf format.</p> <pre><code>egrep -R '(inherit|include)' . | python3 build_include.py | dot -Tpdf &gt; build-includes.pdf\n</code></pre> <p>NOTE: Replace the <code>.</code> with your desired path in which you want to create the graph of all mk files.</p>"}]}